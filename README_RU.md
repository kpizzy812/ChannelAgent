# ChannelAgent

![Python](https://img.shields.io/badge/Python-3.9+-3776AB?style=for-the-badge&logo=python&logoColor=white)
![Telegram](https://img.shields.io/badge/Telegram-Bot%20API-26A5E4?style=for-the-badge&logo=telegram&logoColor=white)
![OpenAI](https://img.shields.io/badge/OpenAI-GPT--4-412991?style=for-the-badge&logo=openai&logoColor=white)
![License](https://img.shields.io/badge/License-Proprietary-red?style=for-the-badge)

**[README in English](README.md)**

AI-агент для автоматического мониторинга Telegram-каналов, анализа контента с помощью GPT-4 Vision и публикации отобранных постов в вашем уникальном стиле.

## Возможности

- **Мониторинг каналов** - Отслеживание неограниченного количества Telegram-каналов через UserBot (Telethon)
- **AI-анализ контента** - GPT-4 Vision анализирует текст и изображения, оценивая релевантность
- **Умная фильтрация** - Настраиваемый порог релевантности (шкала 1-10)
- **Рестайлинг контента** - AI переписывает посты в вашем авторском стиле
- **Интерфейс модерации** - Telegram-бот с inline-кнопками для одобрения контента
- **Отложенная публикация** - Планирование постов на оптимальное время (часовой пояс UTC+3)
- **Ежедневный крипто-дайджест** - Автоматические обновления курсов криптовалют через CoinGecko
- **Telegram-форматирование** - Полная поддержка жирного, курсива, спойлеров, цитат и других стилей

## Архитектура

```
                    +------------------+
                    |   Исходные       |
                    |   каналы         |
                    +--------+---------+
                             |
                    +--------v---------+
                    |    UserBot       |
                    |   (Telethon)     |
                    +--------+---------+
                             |
                    +--------v---------+
                    |   AI-процессор   |
                    |   (OpenAI GPT-4) |
                    +--------+---------+
                             |
              +--------------+--------------+
              |                             |
     +--------v---------+         +--------v---------+
     |   База данных    |         |   Модерация      |
     |   (SQLite)       |         |   Бот (aiogram)  |
     +------------------+         +--------+---------+
                                           |
                                  +--------v---------+
                                  |   Целевой        |
                                  |   канал          |
                                  +------------------+
```

### Основные модули

| Модуль | Технология | Назначение |
|--------|------------|------------|
| `userbot/` | Telethon | Мониторинг исходных каналов, получение новых постов |
| `bot/` | aiogram 3.x | Админ-интерфейс, модерация, команды |
| `ai/` | OpenAI API | Анализ контента, оценка релевантности, рестайлинг |
| `database/` | aiosqlite | Хранение данных, история постов, настройки |
| `scheduler/` | APScheduler | Планировщик задач, ежедневные дайджесты, отложенные посты |

## Технологический стек

- **Python 3.9+** - Полностью асинхронный код (async/await)
- **aiogram 3.x** - Современный Telegram Bot фреймворк
- **Telethon** - MTProto клиент для UserBot
- **OpenAI API** - GPT-4 Turbo + Vision для анализа контента
- **aiosqlite** - Асинхронная работа с SQLite
- **APScheduler** - Фоновое планирование задач
- **loguru** - Продвинутое логирование с ротацией
- **Pydantic** - Валидация конфигурации

## Установка

### Требования

- Python 3.9 или выше
- Telegram Bot Token (от [@BotFather](https://t.me/BotFather))
- Telegram API credentials (с [my.telegram.org](https://my.telegram.org))
- OpenAI API Key

### Настройка

1. **Клонировать репозиторий**
   ```bash
   git clone https://github.com/yourusername/ChannelAgent.git
   cd ChannelAgent
   ```

2. **Создать виртуальное окружение**
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/macOS
   # или
   venv\Scripts\activate     # Windows
   ```

3. **Установить зависимости**
   ```bash
   pip install -r requirements.txt
   ```

4. **Настроить переменные окружения**
   ```bash
   cp .env.example .env
   # Отредактировать .env с вашими данными
   ```

5. **Запустить приложение**
   ```bash
   python main.py
   ```

## Конфигурация

Скопируйте `.env.example` в `.env` и настройте:

```env
# Telegram Bot
BOT_TOKEN=токен_бота
OWNER_ID=ваш_telegram_id

# Telegram UserBot (для мониторинга каналов)
API_ID=ваш_api_id
API_HASH=ваш_api_hash
PHONE_NUMBER=+79001234567

# OpenAI
OPENAI_API_KEY=ваш_openai_api_key
OPENAI_MODEL=gpt-4-turbo

# Настройки контента
MONITORING_INTERVAL=300        # Интервал проверки в секундах
RELEVANCE_THRESHOLD=6          # Минимальный порог релевантности (1-10)

# Целевой канал
TARGET_CHANNEL_ID=-100xxxxxxxxx

# Расписание
DAILY_POST_TIME=09:00
TIMEZONE=Europe/Moscow
```

## Структура проекта

```
src/
├── bot/                    # Telegram Bot (aiogram 3.x)
│   ├── handlers/           # Обработчики команд и callback
│   │   ├── commands.py     # /start, /help, /status
│   │   ├── moderation.py   # Процесс модерации постов
│   │   ├── channels.py     # Управление каналами
│   │   └── daily_posts.py  # Настройка ежедневного дайджеста
│   ├── keyboards/          # Inline и reply клавиатуры
│   └── states/             # FSM состояния
├── userbot/                # Монитор каналов (Telethon)
│   ├── client.py           # Настройка Telethon клиента
│   └── handlers/           # Обработчики новых сообщений
├── ai/                     # AI обработка (OpenAI)
│   ├── client.py           # Обёртка OpenAI API
│   ├── analyzer/           # Анализ контента
│   │   ├── relevance.py    # Оценка релевантности
│   │   └── vision.py       # Анализ изображений
│   └── styler/             # Рестайлинг контента
│       └── formatter.py    # Telegram форматирование
├── database/               # Слой данных (SQLite)
│   ├── models/             # Модели данных
│   └── crud/               # CRUD операции
├── scheduler/              # Планировщик задач (APScheduler)
│   └── tasks/              # Запланированные задачи
└── utils/                  # Утилиты
    ├── config.py           # Управление конфигурацией
    └── logging_config.py   # Настройка loguru
```

## Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Инициализация бота, главное меню |
| `/help` | Показать справку |
| `/status` | Статус мониторинга |
| `/channels` | Управление отслеживаемыми каналами |
| `/settings` | Настройки бота |
| `/daily` | Настройка ежедневного дайджеста |

## Процесс модерации

1. **Обнаружение поста** - UserBot находит новый пост в отслеживаемом канале
2. **AI-анализ** - GPT-4 Vision анализирует контент и изображения
3. **Проверка релевантности** - Посты ниже порога автоматически отклоняются
4. **Очередь модерации** - Релевантные посты отправляются владельцу с inline-кнопками:
   - Опубликовать сейчас
   - Запланировать на позже
   - Редактировать контент
   - Отклонить

## Особенности реализации

### Асинхронность
Весь код написан с использованием `async/await`, что обеспечивает высокую производительность при работе с множеством каналов и API-запросами.

### Типизация
Строгая типизация с использованием type hints для всех функций, что упрощает поддержку и отладку кода.

### Логирование
Используется `loguru` с автоматической ротацией логов, цветной подсветкой в консоли и раздельным логированием ошибок.

### Обработка ошибок
Все внешние API-вызовы обёрнуты в try/except с повторными попытками и экспоненциальной задержкой.

## Лицензия

Данный проект является проприетарным программным обеспечением. Подробности в файле [LICENSE](LICENSE).

## Автор

Разработано с фокусом на чистую архитектуру и лучшие практики асинхронного программирования.

---

*Построено на aiogram 3.x, Telethon и OpenAI GPT-4*

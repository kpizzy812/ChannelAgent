#!/bin/bash

# –¶–≤–µ—Ç–∞ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
SERVER="syntra"
REMOTE_PATH="/home/agent"
LOCAL_PATH="."
PROJECT_NAME="ChannelAgent"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
show_header() {
    clear
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë                  ü§ñ –ö–ê–ù–ê–õ –ê–ì–ï–ù–¢ –ú–ï–ù–ï–î–ñ–ï–†                     ‚ïë${NC}"
    echo -e "${CYAN}‚ïë                     –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è                        ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é
show_menu() {
    echo -e "${BLUE}–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:${NC}"
    echo ""
    echo -e "${GREEN}1.${NC} üì§ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
    echo -e "${GREEN}2.${NC} üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è"
    echo -e "${GREEN}3.${NC} ‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞"
    echo -e "${GREEN}4.${NC} ‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≥–µ–Ω—Ç–∞"
    echo -e "${GREEN}5.${NC} üìä –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
    echo -e "${GREEN}6.${NC} üì• –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞"
    echo -e "${GREEN}7.${NC} üìã –°—Ç–∞—Ç—É—Å –∞–≥–µ–Ω—Ç–∞"
    echo -e "${RED}0.${NC} ‚ùå –í—ã—Ö–æ–¥"
    echo ""
    echo -ne "${YELLOW}–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä: ${NC}"
}

# –§—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
sync_from_server() {
    echo -e "\n${BLUE}üì• –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞...${NC}"
    
    if [ ! -f ".rsyncignore" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  –§–∞–π–ª .rsyncignore –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—é —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π...${NC}"
        create_rsyncignore
    fi
    
    echo -e "${CYAN}–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é —Ñ–∞–π–ª—ã (–∏—Å–∫–ª—é—á–∞—è –º–µ–¥–∏–∞ –∏ –∫–æ–Ω—Ñ–∏–≥–∏)...${NC}"
    rsync -avz --progress --exclude-from=.rsyncignore ${SERVER}:${REMOTE_PATH}/ ${LOCAL_PATH}/
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!${NC}"
    else
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏!${NC}"
    fi
    
    read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
}

# –§—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
sync_to_server() {
    echo -e "\n${BLUE}üì§ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...${NC}"
    
    if [ ! -f ".rsyncignore" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  –§–∞–π–ª .rsyncignore –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—é —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π...${NC}"
        create_rsyncignore
    fi
    
    echo -e "${CYAN}–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä...${NC}"
    echo -e "${YELLOW}–ò—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ .rsyncignore:${NC}"
    grep -E "userbot_session|monitoring_state" .rsyncignore || echo "–ù–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è —Å–µ—Å—Å–∏–∏!"
    rsync -avz --progress --exclude-from=.rsyncignore ${LOCAL_PATH}/ ${SERVER}:${REMOTE_PATH}/
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!${NC}"
    else
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä!${NC}"
    fi
    
    read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
}

# –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è .rsyncignore
create_rsyncignore() {
    cat > .rsyncignore << 'EOF'
# Python cache –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
pip-wheel-metadata/
share/python-wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
venv/
.venv/
env/
.env/
ENV/
env.bak/
venv.bak/

# –õ–æ–≥–∏
logs/
*.log
*.log.*

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ env —Ñ–∞–π–ª—ã (–æ—Å–Ω–æ–≤–Ω–æ–π .env –¥–æ–ª–∂–µ–Ω —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è)
.env.*

# –í–°–Ø –ø–∞–ø–∫–∞ data/ - —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å!
# (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö, —Å–µ—Å—Å–∏—è UserBot, –º–µ–¥–∏–∞ —Ñ–∞–π–ª—ã)
data/

# macOS —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã
.DS_Store
.AppleDouble
.LSOverride
._*

# IDE –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
.idea/
.vscode/
*.swp
*.swo
*~

# –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
tmp/
temp/
*.tmp
*.bak
*.backup

# Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
.git/
.gitignore

# –î—Ä—É–≥–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
*.pid
core.*
*.core
EOF
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
setup_environment() {
    echo -e "\n${BLUE}üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è...${NC}"
    
    echo -e "${CYAN}–í—ã–ø–æ–ª–Ω—è—é –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ${SERVER}...${NC}"
    
    ssh ${SERVER} << 'ENDSSH'
        cd /home/agent

        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞..."
        pwd
        ls -la

        echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ python3-venv..."
        apt update > /dev/null 2>&1
        apt install -y python3.12-venv > /dev/null 2>&1

        echo "üêç –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
        echo "–£–¥–∞–ª—è—é —Å—Ç–∞—Ä–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å..."
        rm -rf .venv
        python3 -m venv .venv

        if [ -f ".venv/bin/activate" ]; then
            echo "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ"
        else
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è"
            exit 1
        fi

        echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
        source .venv/bin/activate
        pip install --upgrade pip
        
        if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
            echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
        else
            echo "‚ö†Ô∏è  –§–∞–π–ª requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
        
        echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
        mkdir -p data/media/photos data/media/videos data/media/thumbnails logs
        
        echo "üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
ENDSSH
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!${NC}"
    else
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è!${NC}"
    fi
    
    read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
}

# –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –∞–≥–µ–Ω—Ç–∞
start_agent() {
    echo -e "\n${BLUE}‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞...${NC}"
    
    echo -e "${CYAN}–ó–∞–ø—É—Å–∫–∞—é –∞–≥–µ–Ω—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ${SERVER}...${NC}"
    
    ssh ${SERVER} << 'ENDSSH'
        cd /home/agent
        
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∞–≥–µ–Ω—Ç–∞..."
        if pgrep -f "python.*main.py" > /dev/null; then
            echo "‚ö†Ô∏è  –ê–≥–µ–Ω—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω!"
            echo "–ó–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
            pgrep -f "python.*main.py" | while read pid; do
                echo "PID: $pid - $(ps -p $pid -o args --no-headers)"
            done
            exit 1
        fi
        
        echo "üöÄ –ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞..."

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        if [ ! -f ".venv/bin/activate" ]; then
            echo "‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ! –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è'"
            exit 1
        fi

        source .venv/bin/activate

        # –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ —Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ª–æ–≥–æ–≤
        nohup python3 main.py > agent.log 2>&1 &
        AGENT_PID=$!
        
        echo "‚úÖ –ê–≥–µ–Ω—Ç –∑–∞–ø—É—â–µ–Ω —Å PID: $AGENT_PID"
        echo $AGENT_PID > agent.pid
        
        # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
        sleep 3
        if ps -p $AGENT_PID > /dev/null; then
            echo "‚úÖ –ê–≥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
        else
            echo "‚ùå –û—à–∏–±–∫–∞: –∞–≥–µ–Ω—Ç –Ω–µ —Å–º–æ–≥ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è"
            echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
            tail -10 agent.log
        fi
ENDSSH
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ –ê–≥–µ–Ω—Ç –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!${NC}"
    else
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∞–≥–µ–Ω—Ç–∞!${NC}"
    fi
    
    read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
}

# –§—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–≥–µ–Ω—Ç–∞
stop_agent() {
    echo -e "\n${BLUE}‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≥–µ–Ω—Ç–∞...${NC}"
    
    echo -e "${CYAN}–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∞–≥–µ–Ω—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ${SERVER}...${NC}"
    
    ssh ${SERVER} << 'ENDSSH'
        cd /home/agent
        
        echo "üîç –ü–æ–∏—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∞–≥–µ–Ω—Ç–∞..."
        PIDS=$(pgrep -f "python.*main.py")
        
        if [ -z "$PIDS" ]; then
            echo "‚ÑπÔ∏è  –ü—Ä–æ—Ü–µ—Å—Å—ã –∞–≥–µ–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            # –£–¥–∞–ª—è–µ–º pid —Ñ–∞–π–ª –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            rm -f agent.pid
        else
            echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø—Ä–æ—Ü–µ—Å—Å—ã:"
            echo "$PIDS" | while read pid; do
                echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é PID: $pid - $(ps -p $pid -o args --no-headers)"
                kill $pid
            done
            
            # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è graceful shutdown
            sleep 3
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å
            REMAINING=$(pgrep -f "python.*main.py")
            if [ ! -z "$REMAINING" ]; then
                echo "‚ö†Ô∏è  –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
                echo "$REMAINING" | while read pid; do
                    kill -9 $pid
                done
            fi
            
            rm -f agent.pid
            echo "‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∞–≥–µ–Ω—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
        fi
ENDSSH
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ –ê–≥–µ–Ω—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!${NC}"
    else
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∞–≥–µ–Ω—Ç–∞!${NC}"
    fi
    
    read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤
view_logs() {
    echo -e "\n${BLUE}üìä –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏...${NC}"
    echo -e "${YELLOW}–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞${NC}"
    echo ""
    
    ssh ${SERVER} "cd /home/agent && tail -f agent.log"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
check_status() {
    echo -e "\n${BLUE}üìã –°—Ç–∞—Ç—É—Å –∞–≥–µ–Ω—Ç–∞...${NC}"
    
    ssh ${SERVER} << 'ENDSSH'
        cd /home/agent
        
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∞–≥–µ–Ω—Ç–∞..."
        PIDS=$(pgrep -f "python.*main.py")
        
        if [ -z "$PIDS" ]; then
            echo "‚ùå –ê–≥–µ–Ω—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"
        else
            echo "‚úÖ –ê–≥–µ–Ω—Ç –∑–∞–ø—É—â–µ–Ω:"
            echo "$PIDS" | while read pid; do
                echo "  PID: $pid - $(ps -p $pid -o args --no-headers)"
                echo "  –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: $(ps -p $pid -o etime --no-headers | tr -d ' ')"
                echo "  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU: $(ps -p $pid -o %cpu --no-headers | tr -d ' ')%"
                echo "  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: $(ps -p $pid -o %mem --no-headers | tr -d ' ')%"
            done
        fi
        
        echo ""
        echo "üìÅ –†–∞–∑–º–µ—Ä –ª–æ–≥ —Ñ–∞–π–ª–∞:"
        if [ -f "agent.log" ]; then
            ls -lh agent.log | awk '{print "  " $5 " (" $9 ")"}'
            echo ""
            echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞:"
            tail -5 agent.log | sed 's/^/  /'
        else
            echo "  –õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
        
        echo ""
        echo "üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞:"
        df -h . | tail -1 | awk '{print "  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: " $3 " –∏–∑ " $2 " (" $5 ")"}'
ENDSSH
    
    read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
}

# –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–æ–≥—Ä–∞–º–º—ã
main() {
    while true; do
        show_header
        show_menu
        read -r choice
        
        case $choice in
            1)
                sync_to_server
                ;;
            2)
                setup_environment
                ;;
            3)
                start_agent
                ;;
            4)
                stop_agent
                ;;
            5)
                view_logs
                ;;
            6)
                sync_from_server
                ;;
            7)
                check_status
                ;;
            0)
                echo -e "\n${GREEN}üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!${NC}"
                exit 0
                ;;
            *)
                echo -e "\n${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 7.${NC}"
                sleep 2
                ;;
        esac
    done
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
check_ssh_connection() {
    echo -e "${CYAN}üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É ${SERVER}...${NC}"
    if ssh -o ConnectTimeout=5 ${SERVER} "echo '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ'" > /dev/null 2>&1; then
        echo -e "${GREEN}‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ${NC}"
        return 0
    else
        echo -e "${RED}‚ùå –ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É ${SERVER}${NC}"
        echo -e "${YELLOW}–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:${NC}"
        echo -e "  ‚Ä¢ SSH –∫–ª—é—á –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
        echo -e "  ‚Ä¢ –ê–ª–∏–∞—Å 'syntra' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ ~/.ssh/config"
        echo -e "  ‚Ä¢ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω"
        exit 1
    fi
}

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
echo -e "${CYAN}–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ö–∞–Ω–∞–ª –ê–≥–µ–Ω—Ç –ú–µ–Ω–µ–¥–∂–µ—Ä–∞...${NC}"
check_ssh_connection
sleep 1
main
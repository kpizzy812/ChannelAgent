"""
OpenAI API –∫–ª–∏–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å OpenAI API —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –¢–ó
"""

import asyncio
import base64
from typing import Optional, Dict, Any, List
from pathlib import Path

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û loguru)
from loguru import logger

# –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
import openai
from openai import AsyncOpenAI

# –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã
from src.utils.config import get_config
from src.utils.exceptions import AIProcessingError

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞ –º–æ–¥—É–ª—è
logger = logger.bind(module="ai_client")


class OpenAIClient:
    """
    –ö–ª–∏–µ–Ω—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å OpenAI API
    –†–µ–∞–ª–∏–∑—É–µ—Ç –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
    """
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI –∫–ª–∏–µ–Ω—Ç–∞"""
        self.config = get_config()
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç OpenAI
        self.client = AsyncOpenAI(
            api_key=self.config.OPENAI_API_KEY
        )
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤
        self.text_model = self.config.OPENAI_MODEL
        self.vision_model = "gpt-4-vision-preview"  # –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        self.default_temperature = 0.3  # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        self.default_max_tokens = 1500   # –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ —Ä–µ—Å—Ç–∞–π–ª–∏–Ω–≥–∞
        
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω OpenAI –∫–ª–∏–µ–Ω—Ç —Å –º–æ–¥–µ–ª—å—é: {}", self.text_model)
    
    async def analyze_relevance_and_sentiment(
        self,
        text: str,
        image_description: Optional[str] = None,
        user_examples: Optional[List[str]] = None,
        max_retries: int = 3
    ) -> Dict[str, Any]:
        """
        –ê–Ω–∞–ª–∏–∑ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        
        Args:
            text: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞
            image_description: –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
            user_examples: –ü—Ä–∏–º–µ—Ä—ã –ø–æ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å—Ç–∏–ª—è
            max_retries: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞
        """
        
        for attempt in range(max_retries):
            try:
                logger.debug("–ê–Ω–∞–ª–∏–∑ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ (–ø–æ–ø—ã—Ç–∫–∞ {})", attempt + 1)
                
                # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
                prompt = self._build_analysis_prompt(text, image_description, user_examples)
                
                # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenAI
                response = await self.client.chat.completions.create(
                    model=self.text_model,
                    messages=[
                        {"role": "system", "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –∏ —Å—Ç–∞–π–ª–∏–Ω–≥—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ —Å—Ñ–µ—Ä–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –∏ –º–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏–∫–∏."},
                        {"role": "user", "content": prompt}
                    ],
                    temperature=self.default_temperature,
                    max_tokens=self.default_max_tokens
                )
                
                # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
                result = self._parse_analysis_response(response.choices[0].message.content)
                
                logger.info("–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω: —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å={}, —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å={}", 
                          result.get("relevance_score"), result.get("sentiment"))
                
                return result
                
            except openai.RateLimitError as e:
                logger.warning("Rate limit OpenAI (–ø–æ–ø—ã—Ç–∫–∞ {}): {}", attempt + 1, str(e))
                if attempt < max_retries - 1:
                    await asyncio.sleep(2 ** attempt)  # Exponential backoff
                continue
                
            except openai.APIError as e:
                logger.error("–û—à–∏–±–∫–∞ OpenAI API: {}", str(e))
                if attempt == max_retries - 1:
                    raise AIProcessingError(f"OpenAI API error: {str(e)}")
                await asyncio.sleep(1)
                
            except Exception as e:
                logger.error("–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {}", str(e))
                if attempt == max_retries - 1:
                    raise AIProcessingError(f"Unexpected error: {str(e)}")
                await asyncio.sleep(1)
        
        raise AIProcessingError("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫")
    
    async def analyze_image(self, image_data: bytes, max_retries: int = 3) -> str:
        """
        –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é Vision API
        
        Args:
            image_data: –ë–∞–π—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            max_retries: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
            
        Returns:
            –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        """
        
        for attempt in range(max_retries):
            try:
                logger.debug("–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Vision API (–ø–æ–ø—ã—Ç–∫–∞ {})", attempt + 1)
                
                # –ö–æ–¥–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64
                image_base64 = base64.b64encode(image_data).decode('utf-8')
                
                # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                response = await self.client.chat.completions.create(
                    model=self.vision_model,
                    messages=[
                        {
                            "role": "user",
                            "content": [
                                {
                                    "type": "text", 
                                    "text": "–û–ø–∏—à–∏ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ –∫–ª—é—á–µ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —Ç–µ–∫—Å—Ç–µ, –≥—Ä–∞—Ñ–∏–∫–∞—Ö, –ª—é–¥—è—Ö –∏ –æ–±—ä–µ–∫—Ç–∞—Ö. –≠—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –ø–æ—Å—Ç–∞ –æ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞—Ö/–º–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏–∫–µ/–±–ª–æ–∫—á–µ–π–Ω."
                                },
                                {
                                    "type": "image_url",
                                    "image_url": {
                                        "url": f"data:image/jpeg;base64,{image_base64}",
                                        "detail": "high"
                                    }
                                }
                            ]
                        }
                    ],
                    temperature=0.3,
                    max_tokens=800
                )
                
                description = response.choices[0].message.content.strip()
                
                logger.info("–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω: {} —Å–∏–º–≤–æ–ª–æ–≤", len(description))
                
                return description
                
            except openai.RateLimitError as e:
                logger.warning("Rate limit –¥–ª—è Vision API: {}", str(e))
                if attempt < max_retries - 1:
                    await asyncio.sleep(3 ** attempt)
                continue
                
            except Exception as e:
                logger.error("–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {}", str(e))
                if attempt == max_retries - 1:
                    return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
                await asyncio.sleep(2)
        
        return "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
    
    async def stylize_user_content(
        self,
        original_text: str,
        user_examples: List[str],
        category: Optional[str] = None,
        max_retries: int = 3
    ) -> Dict[str, Any]:
        """
        –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ–¥ —Å—Ç–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            original_text: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
            user_examples: –ü—Ä–∏–º–µ—Ä—ã –ø–æ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            category: –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            max_retries: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
            
        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
        """
        
        for attempt in range(max_retries):
            try:
                logger.debug("–°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–ø–æ–ø—ã—Ç–∫–∞ {})", attempt + 1)
                
                # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
                prompt = self._build_stylization_prompt(original_text, user_examples, category)
                
                # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenAI
                response = await self.client.chat.completions.create(
                    model=self.text_model,
                    messages=[
                        {"role": "system", "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—Ç–∞–π–ª–∏–Ω–≥—É Telegram –ø–æ—Å—Ç–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å –ø–æ—Å—Ç –ø–æ–¥ —Å—Ç–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–æ—Ö—Ä–∞–Ω–∏–≤ –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é."},
                        {"role": "user", "content": prompt}
                    ],
                    temperature=0.4,  # –ù–µ–º–Ω–æ–≥–æ –≤—ã—à–µ –¥–ª—è –±–æ–ª–µ–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ–π —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
                    max_tokens=1200
                )
                
                # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
                result = self._parse_stylization_response(response.choices[0].message.content)
                
                logger.info("–°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: –∫–∞—Ç–µ–≥–æ—Ä–∏—è={}, –∏–∑–º–µ–Ω–µ–Ω–∏—è={}",
                           result.get("category", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"), 
                           original_text != result.get("stylized_text", ""))
                
                return result
                
            except openai.RateLimitError as e:
                logger.warning("Rate limit –ø—Ä–∏ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ (–ø–æ–ø—ã—Ç–∫–∞ {}): {}", attempt + 1, str(e))
                if attempt < max_retries - 1:
                    await asyncio.sleep(2 ** attempt)
                continue
                
            except Exception as e:
                logger.error("–û—à–∏–±–∫–∞ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏: {}", str(e))
                if attempt == max_retries - 1:
                    return {
                        "success": False,
                        "stylized_text": original_text,
                        "category": category,
                        "error": str(e)
                    }
                await asyncio.sleep(1)
        
        return {
            "success": False, 
            "stylized_text": original_text,
            "category": category,
            "error": "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫"
        }
    
    async def uniqualize_content(
        self,
        original_text: str,
        user_examples: List[str],
        max_retries: int = 3
    ) -> Dict[str, Any]:
        """
        –≠–¢–ê–ü 1: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        –ö–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ –ø–µ—Ä–µ–¥–µ–ª—ã–≤–∞–µ—Ç –ø–æ—Å—Ç, —Å–æ—Ö—Ä–∞–Ω—è—è —Å–º—ã—Å–ª –∏ –∫–ª—é—á–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        
        Args:
            original_text: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞
            user_examples: –ü—Ä–∏–º–µ—Ä—ã –ø–æ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å—Ç–∏–ª—è
            max_retries: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
            
        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏–∏
        """
        
        for attempt in range(max_retries):
            try:
                logger.debug("–≠—Ç–∞–ø 1: –£–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–ø–æ–ø—ã—Ç–∫–∞ {})", attempt + 1)
                
                # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏–∏
                prompt = self._build_uniqualization_prompt(original_text, user_examples)
                
                # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenAI
                response = await self.client.chat.completions.create(
                    model=self.text_model,
                    messages=[
                        {"role": "system", "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å –ø–æ—Å—Ç, –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–º–µ–Ω–∏–≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–≤ –≤—Å–µ –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–º—ã—Å–ª."},
                        {"role": "user", "content": prompt}
                    ],
                    temperature=0.7,  # –í—ã—Å–æ–∫–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏–∏
                    max_tokens=1500
                )
                
                # –ü–æ–ª—É—á–∞–µ–º RAW –æ—Ç–≤–µ—Ç –æ—Ç AI
                raw_response = response.choices[0].message.content
                
                # üîç DEBUG: –ü–æ–ª–Ω—ã–π RAW –æ—Ç–≤–µ—Ç AI –Ω–∞ —ç—Ç–∞–ø–µ 1
                logger.info("üéØ –≠–¢–ê–ü 1 - RAW –û–¢–í–ï–¢ AI:\n{}", repr(raw_response))
                logger.info("üéØ –≠–¢–ê–ü 1 - –í–ò–ó–£–ê–õ–¨–ù–´–ô –û–¢–í–ï–¢ AI:\n{}", raw_response)
                
                # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
                result = self._parse_uniqualization_response(raw_response)
                
                # üîç DEBUG: –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞
                logger.info("üîß –≠–¢–ê–ü 1 - –ü–û–°–õ–ï –ü–ê–†–°–ò–ù–ì–ê:\n{}", repr(result.get("uniqualized_text", "")))
                
                logger.info("–≠—Ç–∞–ø 1 –∑–∞–≤–µ—Ä—à–µ–Ω: —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –∏–∑–º–µ–Ω–µ–Ω–∏–π={}",
                           original_text != result.get("uniqualized_text", ""))
                
                return result
                
            except Exception as e:
                logger.error("–û—à–∏–±–∫–∞ —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏–∏ (–ø–æ–ø—ã—Ç–∫–∞ {}): {}", attempt + 1, str(e))
                if attempt == max_retries - 1:
                    return {
                        "success": False,
                        "uniqualized_text": original_text,
                        "error": str(e)
                    }
                await asyncio.sleep(1)
        
        return {
            "success": False, 
            "uniqualized_text": original_text,
            "error": "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫"
        }
    
    async def format_with_html(
        self,
        text: str,
        max_retries: int = 3
    ) -> Dict[str, Any]:
        """
        –≠–¢–ê–ü 2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        –î–µ–ª–∞–µ—Ç —Ç–µ–∫—Å—Ç –∫—Ä–∞—Å–∏–≤—ã–º —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ HTML —Ç–µ–≥–∞–º–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
        
        Args:
            text: –£–Ω–∏–∫–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            max_retries: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
            
        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        """
        
        for attempt in range(max_retries):
            try:
                logger.debug("–≠—Ç–∞–ø 2: HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–æ–ø—ã—Ç–∫–∞ {})", attempt + 1)
                
                # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                prompt = self._build_html_formatting_prompt(text)
                
                # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenAI
                response = await self.client.chat.completions.create(
                    model=self.text_model,
                    messages=[
                        {"role": "system", "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –¥–ª—è Telegram. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –∫–∞–∂–¥—ã–π –æ—Ç–∫—Ä—ã—Ç—ã–π HTML —Ç–µ–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–∫—Ä—ã—Ç! –ü—Ä–æ–≤–µ—Ä—è–π –∫–∞–∂–¥—ã–π —Ç–µ–≥ –¥–≤–∞–∂–¥—ã."},
                        {"role": "user", "content": prompt}
                    ],
                    temperature=0.1,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –Ω–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    max_tokens=1500
                )
                
                # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç –ë–ï–ó –≤–∞–ª–∏–¥–∞—Ü–∏–∏ HTML (AI —Å–∞–º –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω)
                formatted_text = response.choices[0].message.content.strip()
                
                # üîç DEBUG: –ü–æ–ª–Ω—ã–π RAW –æ—Ç–≤–µ—Ç AI –Ω–∞ —ç—Ç–∞–ø–µ 2
                logger.info("üé® –≠–¢–ê–ü 2 - RAW –û–¢–í–ï–¢ AI:\n{}", repr(formatted_text))
                logger.info("üé® –≠–¢–ê–ü 2 - –í–ò–ó–£–ê–õ–¨–ù–´–ô –û–¢–í–ï–¢ AI:\n{}", formatted_text)
                
                # –£–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ markdown –∫–æ–¥ –±–ª–æ–∫–∏ –µ—Å–ª–∏ AI –∏—Ö –¥–æ–±–∞–≤–∏–ª
                cleaned_text = self._clean_markdown_code_blocks(formatted_text)
                
                # üîç DEBUG: –ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ markdown
                if cleaned_text != formatted_text:
                    logger.info("üßπ –û–ß–ò–©–ï–ù–´ MARKDOWN –ë–õ–û–ö–ò: {} -> {} —Å–∏–º–≤–æ–ª–æ–≤", 
                               len(formatted_text), len(cleaned_text))
                    logger.info("üßπ –†–ï–ó–£–õ–¨–¢–ê–¢ –ü–û–°–õ–ï –û–ß–ò–°–¢–ö–ò:\n{}", repr(cleaned_text))
                
                # üö® –ö–†–ò–¢–ò–ß–ù–û: –ó–∞–º–µ–Ω—è–µ–º –ª–∏—Ç–µ—Ä–∞–ª—å–Ω—ã–µ \n –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
                final_text = cleaned_text.replace('\\n', '\n')
                
                # üîç DEBUG: –ü–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã \n
                if final_text != cleaned_text:
                    logger.info("üîß –ó–ê–ú–ï–ù–ï–ù–´ –õ–ò–¢–ï–†–ê–õ–¨–ù–´–ï \\n: {} -> {} —Å–∏–º–≤–æ–ª–æ–≤", 
                               len(cleaned_text), len(final_text))
                    logger.info("üîß –†–ï–ó–£–õ–¨–¢–ê–¢ –ü–û–°–õ–ï –ó–ê–ú–ï–ù–´ \\n:\n{}", repr(final_text))
                
                # HTML –æ—Ç AI –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                logger.info("‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π HTML –≥–æ—Ç–æ–≤: {} —Å–∏–º–≤–æ–ª–æ–≤", len(final_text))
                
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π HTML
                result = {
                    "success": True,
                    "formatted_text": final_text,
                    "raw_response": formatted_text
                }
                
                logger.info("–≠—Ç–∞–ø 2 –∑–∞–≤–µ—Ä—à–µ–Ω: HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ")
                
                return result
                
            except Exception as e:
                logger.error("–û—à–∏–±–∫–∞ HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ–ø—ã—Ç–∫–∞ {}): {}", attempt + 1, str(e))
                if attempt == max_retries - 1:
                    return {
                        "success": False,
                        "formatted_text": text,
                        "error": str(e)
                    }
                await asyncio.sleep(1)
        
        return {
            "success": False, 
            "formatted_text": text,
            "error": "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫"
        }
    
    def _build_stylization_prompt(
        self,
        original_text: str,
        user_examples: List[str],
        category: Optional[str]
    ) -> str:
        """–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
        
        prompt_parts = [
            "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—Ç–∞–π–ª–∏–Ω–≥—É Telegram –ø–æ—Å—Ç–æ–≤ –≤ –∫—Ä–∏–ø—Ç–æ/–º–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π —Å—Ñ–µ—Ä–µ.",
            "",
            "–ü–†–ò–ú–ï–†–´ –ú–û–ï–ì–û –°–¢–ò–õ–Ø:"
        ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        for i, example in enumerate(user_examples[:3], 1):
            prompt_parts.append(f"–ü—Ä–∏–º–µ—Ä {i}: {example}")
        
        prompt_parts.extend([
            "",
            "–ó–ê–î–ê–ß–ê: –ü–µ—Ä–µ–¥–µ–ª–∞–π —Å–ª–µ–¥—É—é—â–∏–π –ø–æ—Å—Ç –ø–æ–¥ –º–æ–π —Å—Ç–∏–ª—å:",
            "1. üåç –ï—Å–ª–∏ –ø–æ—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º - –ø–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ —Ä—É—Å—Å–∫–∏–π",
            "2. üìù –ò—Å–ø–æ–ª—å–∑—É–π Telegram —Ä–∞–∑–º–µ—Ç–∫—É: **–∂–∏—Ä–Ω—ã–π**, *–∫—É—Ä—Å–∏–≤*, >—Ü–∏—Ç–∞—Ç—ã, __–ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π__, ||—Å–ø–æ–π–ª–µ—Ä||",
            "3. üé® –î–æ–±–∞–≤—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —ç–º–æ–¥–∑–∏",
            "4. üíé –°–æ—Ö—Ä–∞–Ω–∏ –≤—Å—é –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é",
            "5. ‚ö° –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π —Ç–µ–∫—Å—Ç –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è",
            "",
            f"–ò–°–•–û–î–ù–´–ô –¢–ï–ö–°–¢: {original_text}",
            ""
        ])
        
        if category:
            prompt_parts.append(f"–ö–ê–¢–ï–ì–û–†–ò–Ø: {category}")
            prompt_parts.append("")
        
        prompt_parts.extend([
            "–û–¢–í–ï–¢ –í –§–û–†–ú–ê–¢–ï:",
            "–ö–ê–¢–ï–ì–û–†–ò–Ø: [crypto/macro/web3/telegram/gamefi/general]",
            "–°–¢–ò–õ–ò–ó–û–í–ê–ù–ù–´–ô –ü–û–°–¢:",
            "[–ø–µ—Ä–µ–¥–µ–ª–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ —ç–º–æ–¥–∑–∏]"
        ])
        
        return "\n".join(prompt_parts)
    
    def _parse_stylization_response(self, response_text: str) -> Dict[str, Any]:
        """–ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏"""
        try:
            lines = response_text.strip().split('\n')
            
            result = {
                "success": True,
                "stylized_text": "",
                "category": "general",
                "raw_response": response_text
            }
            
            stylized_text_lines = []
            collecting_stylized_text = False
            
            for line in lines:
                line = line.strip()
                
                # –ü–∞—Ä—Å–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                if line.startswith("–ö–ê–¢–ï–ì–û–†–ò–Ø:"):
                    try:
                        category_text = line.split(":", 1)[1].strip().lower()
                        valid_categories = ["crypto", "macro", "web3", "telegram", "gamefi", "general"]
                        if any(cat in category_text for cat in valid_categories):
                            result["category"] = next(cat for cat in valid_categories if cat in category_text)
                    except:
                        logger.debug("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑: {}", line)
                
                # –ù–∞—á–∏–Ω–∞–µ–º —Å–æ–±–∏—Ä–∞—Ç—å —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
                elif line.startswith("–°–¢–ò–õ–ò–ó–û–í–ê–ù–ù–´–ô –ü–û–°–¢:"):
                    collecting_stylized_text = True
                elif collecting_stylized_text and line:
                    stylized_text_lines.append(line)
            
            # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            if stylized_text_lines:
                result["stylized_text"] = "\n".join(stylized_text_lines).strip()
            else:
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å, –±–µ—Ä–µ–º –≤–µ—Å—å –æ—Ç–≤–µ—Ç –∫–∞–∫ —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
                result["stylized_text"] = response_text.strip()
            
            return result
            
        except Exception as e:
            logger.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏: {}", str(e))
            return {
                "success": False,
                "stylized_text": response_text or "–û—à–∏–±–∫–∞ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏",
                "category": "general",
                "error": str(e),
                "raw_response": response_text
            }
    
    def _build_analysis_prompt(
        self, 
        text: str, 
        image_description: Optional[str], 
        user_examples: Optional[List[str]]
    ) -> str:
        """–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó"""
        
        # –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç —Å–æ–≥–ª–∞—Å–Ω–æ TECHNICAL_SPECIFICATION.md
        prompt_parts = [
            "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—Ç–∞–π–ª–∏–Ω–≥—É Telegram –ø–æ—Å—Ç–æ–≤ –≤ —Å—Ñ–µ—Ä–µ –∫—Ä–∏–ø—Ç–æ/–º–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏–∫–∏.",
            ""
        ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ—Å—Ç—å
        if user_examples:
            prompt_parts.extend([
                "–ü–†–ò–ú–ï–†–´ –ú–û–ï–ì–û –°–¢–ò–õ–Ø:",
                *[f"–ü—Ä–∏–º–µ—Ä {i+1}: {example}" for i, example in enumerate(user_examples[:3])],
                ""
            ])
        
        # –ó–∞–¥–∞—á–∞ —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        prompt_parts.extend([
            "–ó–ê–î–ê–ß–ê: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ—Å—Ç –∏ –£–ù–ò–ö–ê–õ–ò–ó–ò–†–£–ô –µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç, —Å–æ—Ö—Ä–∞–Ω–∏–≤ –°–¢–†–£–ö–¢–£–†–£ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!",
            "",
            "üìù –ö–ê–ö –£–ù–ò–ö–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨:",
            "‚Ä¢ –ü–µ—Ä–µ–ø–∏—à–∏ —Ñ—Ä–∞–∑—ã —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ (—Å–æ—Ö—Ä–∞–Ω–∏ —Å–º—ã—Å–ª)",
            "‚Ä¢ –ò–∑–º–µ–Ω–∏ –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ", 
            "‚Ä¢ –î–æ–±–∞–≤—å/–∑–∞–º–µ–Ω–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —ç–º–æ–¥–∑–∏",
            "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —Å–∏–Ω–æ–Ω–∏–º—ã –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è",
            "",
            "üé® –°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê TELEGRAM –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø:",
            "‚Ä¢ **—Ç–µ–∫—Å—Ç** –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞",
            "‚Ä¢ *—Ç–µ–∫—Å—Ç* –¥–ª—è –∫—É—Ä—Å–∏–≤–∞", 
            "‚Ä¢ >—Ç–µ–∫—Å—Ç –¥–ª—è —Ü–∏—Ç–∞—Ç (–≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏)",
            "‚Ä¢ __—Ç–µ–∫—Å—Ç__ –¥–ª—è –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç–æ–≥–æ",
            "‚Ä¢ ||—Ç–µ–∫—Å—Ç|| –¥–ª—è —Å–ø–æ–π–ª–µ—Ä–æ–≤",
            "‚Ä¢ –ü–†–ò–ú–ï–† –ü–†–ê–í–ò–õ–¨–ù–û: **Bitcoin —Ä–∞—Å—Ç–µ—Ç**, *–∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞*, >–≤–∞–∂–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞",
            "‚Ä¢ –ù–ò–ö–ê–ö–ò–• HTML –¢–ï–ì–û–í! –¢–æ–ª—å–∫–æ Telegram —Ä–∞–∑–º–µ—Ç–∫–∞!",
            "",
            "üö´ –ß–¢–û –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û:",
            "‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTML —Ç–µ–≥–∏ (<b>, <strong>, <i>, –∏ —Ç.–¥.)",
            "‚Ä¢ –°–æ–∑–¥–∞–≤–∞—Ç—å –±–∏—Ç—É—é —Ä–∞–∑–º–µ—Ç–∫—É (–Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ ** –∏–ª–∏ *)",
            "‚Ä¢ –°–º–µ—à–∏–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Ä–∞–∑–º–µ—Ç–∫–∏ –≤ –æ–¥–Ω–æ–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç–µ",
            "‚Ä¢ –ü—É—Å—Ç—ã–µ —Ç–µ–≥–∏ —Ä–∞–∑–º–µ—Ç–∫–∏ (****, ****, –∏ —Ç.–¥.)",
            "",
            "üåç –ü–ï–†–ï–í–û–î: –ï—Å–ª–∏ –ø–æ—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º - –ø–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ —Ä—É—Å—Å–∫–∏–π, —Å–æ—Ö—Ä–∞–Ω–∏–≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!",
            "–ü–µ—Ä–µ–≤–æ–¥–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (mining‚Üí–º–∞–π–Ω–∏–Ω–≥, staking‚Üí—Å—Ç–µ–π–∫–∏–Ω–≥, yield‚Üí–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å).",
            "–°–æ—Ö—Ä–∞–Ω—è–π –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ —Ç–∏–∫–µ—Ä—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ (Bitcoin, Ethereum, BTC, ETH).",
            "",
            "–ö–†–ò–¢–ï–†–ò–ò –†–ï–õ–ï–í–ê–ù–¢–ù–û–°–¢–ò (1-10 –±–∞–ª–ª–æ–≤):",
            "- –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã (Bitcoin, Ethereum, –∞–ª—å—Ç–∫–æ–∏–Ω—ã, DeFi)",
            "- –ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏–∫–∞ (–§–†–°, –∏–Ω—Ñ–ª—è—Ü–∏—è, —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏)",
            "- Web3 (–±–ª–æ–∫—á–µ–π–Ω, NFT, –º–µ—Ç–∞–≤—Å–µ–ª–µ–Ω–Ω—ã–µ)",
            "- Telegram (–Ω–æ–≤–æ—Å—Ç–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã)",
            "- GameFi (–±–ª–æ–∫—á–µ–π–Ω –∏–≥—Ä—ã, play-to-earn)",
            "",
            f"–û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –ü–û–°–¢: {text}",
        ])
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
        if image_description:
            prompt_parts.append(f"–û–ü–ò–°–ê–ù–ò–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø: {image_description}")
        
        prompt_parts.extend([
            "",
            "üîç –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê TELEGRAM –†–ê–ó–ú–ï–¢–ö–ò –ü–ï–†–ï–î –û–¢–í–ï–¢–û–ú:",
            "‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å –∫–∞–∂–¥—ã–π **—Ç–µ–∫—Å—Ç** - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –∑–∞–∫—Ä—ã—Ç?",
            "‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å –∫–∞–∂–¥—ã–π *—Ç–µ–∫—Å—Ç* - –Ω–µ—Ç –ª–∏ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã—Ö?", 
            "‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å –∫–∞–∂–¥—É—é —Ü–∏—Ç–∞—Ç—É >—Ç–µ–∫—Å—Ç - –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫–∏?",
            "‚Ä¢ –ù–ï–¢ –ª–∏ –±–∏—Ç—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π —Ç–∏–ø–∞ ***, ****, |||| ?",
            "‚Ä¢ –ù–ò–ö–ê–ö–ò–• HTML —Ç–µ–≥–æ–≤ –≤ —Ç–µ–∫—Å—Ç–µ?",
            "‚Ä¢ –í–°–Ø —Ä–∞–∑–º–µ—Ç–∫–∞ –≤ Telegram —Ñ–æ—Ä–º–∞—Ç–µ?",
            "",
            "–û–¢–í–ï–¢–¨ –°–¢–†–û–ì–û –í –§–û–†–ú–ê–¢–ï:",
            "–†–ï–õ–ï–í–ê–ù–¢–ù–û–°–¢–¨: [—á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10]",
            "–¢–û–ù–ê–õ–¨–ù–û–°–¢–¨: [–ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è/–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è/–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è]", 
            "–£–ù–ò–ö–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –ü–û–°–¢:",
            "[–ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å TELEGRAM —Ä–∞–∑–º–µ—Ç–∫–æ–π - **–∂–∏—Ä–Ω—ã–π**, *–∫—É—Ä—Å–∏–≤*, >—Ü–∏—Ç–∞—Ç—ã, __–ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π__, ||—Å–ø–æ–π–ª–µ—Ä||]"
        ])
        
        return "\n".join(prompt_parts)
    
    def _build_uniqualization_prompt(self, original_text: str, user_examples: List[str]) -> str:
        """–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
        
        prompt_parts = [
            "üéØ –ó–ê–î–ê–ß–ê: –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –£–ù–ò–ö–ê–õ–ò–ó–ê–¶–ò–Ø –ö–û–ù–¢–ï–ù–¢–ê",
            "",
            "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤ –≤ –∫—Ä–∏–ø—Ç–æ/–º–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π —Å—Ñ–µ—Ä–µ.",
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ö–ê–†–î–ò–ù–ê–õ–¨–ù–û –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å –ø–æ—Å—Ç, –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–º–µ–Ω–∏–≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏.",
        ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å—Ç–∏–ª—è (–° –°–û–•–†–ê–ù–ï–ù–ò–ï–ú HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!)
        if user_examples:
            prompt_parts.extend([
                "",
                "üìù –ü–†–ò–ú–ï–†–´ –ú–û–ï–ì–û –°–¢–ò–õ–Ø (—Å HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç–æ–Ω–∞):",
                *[f"–ü—Ä–∏–º–µ—Ä {i+1}: {example[:200]}..." for i, example in enumerate(user_examples[:2])],
                "",
                "‚ö†Ô∏è –í–ê–ñ–ù–û: –ü—Ä–∏–º–µ—Ä—ã –ø–æ–∫–∞–∑–∞–Ω—ã —Å HTML —Ç–µ–≥–∞–º–∏ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å—Ç–∏–ª—è,",
                "–Ω–æ –¢–´ –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ë–ï–ó —Ç–µ–≥–æ–≤ (—Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ)!"
            ])
        
        prompt_parts.extend([
            "",
            "üîÑ –ö–ê–ö –£–ù–ò–ö–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨:",
            "‚Ä¢ –ü–û–õ–ù–û–°–¢–¨–Æ –∏–∑–º–µ–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ—Å—Ç–∞ - –Ω–∞—á–Ω–∏ —Å –¥—Ä—É–≥–æ–≥–æ —É–≥–ª–∞",
            "‚Ä¢ –ó–∞–º–µ–Ω–∏ –í–°–ï —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ —Å–∏–Ω–æ–Ω–∏–º–∞–º–∏ –∏ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞–Ω–∏–µ–º", 
            "‚Ä¢ –ü–æ–º–µ–Ω—è–π –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏",
            "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π –¥—Ä—É–≥–∏–µ —Ä–µ—á–µ–≤—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥—ã",
            "‚Ä¢ –î–æ–±–∞–≤—å —Å–≤–æ–∏ –∏–Ω—Å–∞–π—Ç—ã –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –≤ —Ç–æ–º –∂–µ —Å—Ç–∏–ª–µ",
            "‚Ä¢ –°–¥–µ–ª–∞–π –ø–æ—Å—Ç –ê–ë–°–û–õ–Æ–¢–ù–û –Ω–µ–ø–æ—Ö–æ–∂–∏–º –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª –ø–æ —Ñ–æ—Ä–º–µ",
            "",
            "‚ö†Ô∏è –í–ê–ñ–ù–û –ü–û –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Æ –ù–ê –≠–¢–û–ú –≠–¢–ê–ü–ï:",
            "‚Ä¢ –ò–ì–ù–û–†–ò–†–£–ô –ª—é–±—ã–µ HTML —Ç–µ–≥–∏ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ç–µ–∫—Å—Ç–µ (<strong>, <i> –∏ —Ç.–¥.)",
            "‚Ä¢ –ù–ï –∫–æ–ø–∏—Ä—É–π HTML —Ç–µ–≥–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ - –æ–Ω–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ",
            "‚Ä¢ –£–ë–ï–†–ò –≤—Å–µ HTML —Ä–∞–∑–º–µ—Ç–∫—É –ø–æ–ª–Ω–æ—Å—Ç—å—é - –≤–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –ß–ò–°–¢–´–ô —Ç–µ–∫—Å—Ç",
            "‚Ä¢ –≠–º–æ–¥–∑–∏ –º–æ–∂–µ—à—å –æ—Å—Ç–∞–≤–∏—Ç—å, –Ω–æ –ë–ï–ó –í–°–ï–• —Ç–µ–≥–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è",
            "",
            "‚ö†Ô∏è –ß–¢–û –°–û–•–†–ê–ù–ò–¢–¨ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:",
            "‚Ä¢ –í–°–ï —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ—Ü–µ–Ω—Ç—ã, –¥–∞—Ç—ã (—Ç–æ—á–Ω–æ –∫–∞–∫ –µ—Å—Ç—å!)",
            "‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤, —Ç–∏–∫–µ—Ä—ã, –∏–º–µ–Ω–∞ (Bitcoin, ETH, Solana –∏ —Ç.–¥.)",
            "‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã –∏ —Å–æ–±—ã—Ç–∏—è",  
            "‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã",
            "‚Ä¢ –°—Å—ã–ª–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å",
            "",
            "üåç –ï–°–õ–ò –ü–û–°–¢ –ù–ê –ê–ù–ì–õ–ò–ô–°–ö–û–ú - –ì–†–ê–ú–û–¢–ù–´–ô –ü–ï–†–ï–í–û–î:",
            "‚Ä¢ –ü–µ—Ä–µ–≤–µ–¥–∏ –≤–µ—Å—å —Ç–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫",
            "‚Ä¢ üèõÔ∏è –ù–ê–ó–í–ê–ù–ò–Ø –ù–ê –ê–ù–ì–õ–ò–ô–°–ö–û–ú: –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–π, –ø—Ä–æ–µ–∫—Ç–æ–≤, –±–∏—Ä–∂–∏, –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (Apple, Microsoft, Binance, Ethereum, Solana)",
            "‚Ä¢ üî§ –¢–ò–ö–ï–†–´ –ù–ê –ê–ù–ì–õ–ò–ô–°–ö–û–ú: –≤—Å–µ —Ç–∏–∫–µ—Ä—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç (BTC, ETH, SOL, MATIC, DOGE)",
            "‚Ä¢ üìö –¢–ï–†–ú–ò–ù–´ –ü–ï–†–ï–í–û–î–ò: mining‚Üí–º–∞–π–Ω–∏–Ω–≥, staking‚Üí—Å—Ç–µ–π–∫–∏–Ω–≥, yield‚Üí–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å, farming‚Üí—Ñ–∞—Ä–º–∏–Ω–≥, trading‚Üí—Ç—Ä–µ–π–¥–∏–Ω–≥",
            "‚Ä¢ üí∞ –§–ò–ù–ê–ù–°–û–í–´–ï –¢–ï–†–ú–ò–ù–´: market cap‚Üí–∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è, volatility‚Üí–≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å, liquidity‚Üí–ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å",
            "‚Ä¢ ‚ö° –¢–ï–•–ù–û –¢–ï–†–ú–ò–ù–´: blockchain‚Üí–±–ª–æ–∫—á–µ–π–Ω, smart contract‚Üí—Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç, DeFi‚ÜíDeFi (–±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–∞)",
            "‚Ä¢ üéØ –ê–î–ê–ü–¢–ò–†–£–ô –ø–æ–¥ —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∞–Ω–≥–ª–∏—Ü–∏–∑–º—ã",
            "",
            f"–ò–°–•–û–î–ù–´–ô –ü–û–°–¢ –î–õ–Ø –£–ù–ò–ö–ê–õ–ò–ó–ê–¶–ò–ò:",
            f"{original_text}",
            "",
            "üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –†–ï–ó–£–õ–¨–¢–ê–¢–£:",
            "‚Ä¢ –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–õ–ù–û–°–¢–¨–Æ –ø–µ—Ä–µ–ø–∏—Å–∞–Ω",
            "‚Ä¢ –ù–∏–∫–∞–∫–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—Ä–∞–∑ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞",
            "‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–º—ã—Å–ª–∞", 
            "‚Ä¢ ‚ö†Ô∏è –ê–ë–°–û–õ–Æ–¢–ù–û –ë–ï–ó HTML —Ç–µ–≥–æ–≤ - —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç!",
            "‚Ä¢ ‚ö†Ô∏è –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π <strong>, <i>, <a> –∏ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Ç–µ–≥–∏!",
            "‚Ä¢ –î–ª–∏–Ω–∞ –ø—Ä–∏–º–µ—Ä–Ω–æ –∫–∞–∫ —É –æ—Ä–∏–≥–∏–Ω–∞–ª–∞",
            "‚Ä¢ –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏, –Ω–æ –ù–ò–ö–ê–ö–ò–• HTML —Ç–µ–≥–æ–≤!",
            "",
            "üö® –≠–¢–ê–ü 1 = –¢–û–õ–¨–ö–û –£–ù–ò–ö–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ï–ó –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø!",
            "",
            "–û–¢–í–ï–¢–¨ –¢–û–õ–¨–ö–û –£–ù–ò–ö–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ú –ß–ò–°–¢–´–ú –¢–ï–ö–°–¢–û–ú –ë–ï–ó HTML –¢–ï–ì–û–í –ò –ë–ï–ó –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í!"
        ])
        
        return "\n".join(prompt_parts)
    
    def _build_html_formatting_prompt(self, text: str) -> str:
        """–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–ø—Ç –¥–ª—è HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
        
        prompt_parts = [
            "üé® –ó–ê–î–ê–ß–ê: –ö–†–ê–°–ò–í–û–ï HTML –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –î–õ–Ø TELEGRAM",
            "",
            "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –¥–ª—è Telegram –∫–∞–Ω–∞–ª–æ–≤.",
            "–¢—ã –ø–æ–ª—É—á–∞–µ—à—å –ß–ò–°–¢–´–ô —Ç–µ–∫—Å—Ç –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –≠—Ç–∞–ø–∞ 1.",
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–æ–±–∞–≤–∏—Ç—å –∫—Ä–∞—Å–∏–≤–æ–µ HTML –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–∑–º–µ—Ç–∫–æ–π.",
            "",
            "üìã –ü–†–ê–í–ò–õ–ê HTML –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –î–õ–Ø TELEGRAM:",
            "‚úÖ –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–ú–´–ï –¢–ï–ì–ò:",
            "‚Ä¢ <b>—Ç–µ–∫—Å—Ç</b>, <strong>—Ç–µ–∫—Å—Ç</strong> –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ",
            "‚Ä¢ <i>—Ç–µ–∫—Å—Ç</i>, <em>—Ç–µ–∫—Å—Ç</em> –¥–ª—è –∫—É—Ä—Å–∏–≤–∞",
            "‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: <code>, <pre>, <u>, <s>, <a>, <div>, <span>",
            "",
            "üéØ –°–¢–†–ê–¢–ï–ì–ò–Ø –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø (—Ç–µ–∫—Å—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –ë–ï–ó HTML!):",
            "1. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –∏ –¥–æ–±–∞–≤–ª—è–π HTML —Ç–µ–≥–∏",
            "2. –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –∫–ª—é—á–µ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã -> –æ–±–µ—Ä–Ω–∏ –≤ <b>",
            "3. –í–∞–∂–Ω—ã–µ —á–∏—Å–ª–∞ –∏ –¥–∞–Ω–Ω—ã–µ -> –æ–±–µ—Ä–Ω–∏ –≤ <b>", 
            "4. –ê–∫—Ü–µ–Ω—Ç—ã –∏ –¥–µ—Ç–∞–ª–∏ -> –æ–±–µ—Ä–Ω–∏ –≤ <i>",
            "5. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –∞–±–∑–∞—Ü—ã –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏",
            "6. –°–æ—Ö—Ä–∞–Ω–∏ –≤—Å–µ —ç–º–æ–¥–∑–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞",
            "7. –ù–ï –º–µ–Ω—è–π —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ - —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–π HTML —Ç–µ–≥–∏!",
            "",
            "üèóÔ∏è –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –ü–û–°–¢–ê:",
            "‚Ä¢ –Ø—Ä–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ <b>",
            "‚Ä¢ –ö–æ—Ä–æ—Ç–∫–∏–µ –ø—É–Ω–∫—Ç—ã –≤ <b> –∏ <i>",
            "‚Ä¢ –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å –∞–Ω–∞–ª–∏–∑–æ–º, –¥–∞–Ω–Ω—ã–º–∏ –∏ –≤—ã–≤–æ–¥–∞–º–∏ –≤ <b> –∏ <i>",
            "‚Ä¢ –§–∏–Ω–∞–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –≤ <b> –∏ <i>",
            "",
            "‚ö° –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö HTML:",
            "‚Ä¢ üö® –ö–ê–ñ–î–´–ô <b> –î–û–õ–ñ–ï–ù –∏–º–µ—Ç—å –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π </b>",
            "‚Ä¢ üö® –ö–ê–ñ–î–´–ô <i> –î–û–õ–ñ–ï–ù –∏–º–µ—Ç—å –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π </i>", 
            "‚Ä¢ üö® –ù–ò–ö–ê–ö–ò–• NESTED –¢–ï–ì–û–í: <b><i>—Ç–µ–∫—Å—Ç</i></b> - –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û!",
            "‚Ä¢ üö® –≠–ú–û–î–ó–ò –í–°–ï–ì–î–ê –†–ê–ó–ú–ï–©–ê–ô –í–ù–£–¢–†–ò –¢–ï–ì–û–í: <i>‚ö°Ô∏è —Ç–µ–∫—Å—Ç</i> –∏–ª–∏ <b>üöÄ –∑–∞–≥–æ–ª–æ–≤–æ–∫</b>",
            "‚Ä¢ üö® –ù–ò–ö–û–ì–î–ê –ù–ï –°–¢–ê–í–¨ –≠–ú–û–î–ó–ò –ú–ï–ñ–î–£ –¢–ï–ì–ê–ú–ò: </i> ‚ö°Ô∏è <i> - –≠–¢–û –õ–û–ú–ê–ï–¢ –ü–ê–†–°–ï–† TELEGRAM!",
            "‚Ä¢ –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –ø—É—Å—Ç—ã–µ —Ç–µ–≥–∏",
            "‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å –î–í–ê–ñ–î–´ –∫–∞–∂–¥—ã–π –æ—Ç–∫—Ä—ã—Ç—ã–π —Ç–µ–≥ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–≥–æ!",
            "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –¥–ª—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏",
            "",
            "üí° –ü–†–ê–í–ò–õ–¨–ù–´–ï –ü–†–ò–ú–ï–†–´:",
            "–í–•–û–î–Ø–©–ò–ô: Bitcoin —Ä–∞—Å—Ç–µ—Ç –∫ $100k ‚ö°Ô∏è –ê–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É—é—Ç —Ä–æ—Å—Ç üöÄ",
            "–ò–°–•–û–î–Ø–©–ò–ô: <b>üöÄ Bitcoin —Ä–∞—Å—Ç–µ—Ç –∫ $100k</b>. <i>‚ö°Ô∏è –ê–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É—é—Ç —Ä–æ—Å—Ç.</i>",
            "",
            "üí° –ü–†–ê–í–ò–õ–¨–ù–û–ï –†–ê–ó–ú–ï–©–ï–ù–ò–ï –≠–ú–û–î–ó–ò:",
            "‚Ä¢ ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: <b>üöÄ –∑–∞–≥–æ–ª–æ–≤–æ–∫</b> –∏–ª–∏ <i>‚ö°Ô∏è —Ç–µ–∫—Å—Ç —Å —ç–º–æ–¥–∑–∏</i>",
            "‚Ä¢ ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: </b> üöÄ <i>—Ç–µ–∫—Å—Ç</i> –∏–ª–∏ <i>—Ç–µ–∫—Å—Ç</i> ‚ö°Ô∏è <b>–∑–∞–≥–æ–ª–æ–≤–æ–∫</b>",
            "‚Ä¢ –ö–∞–∂–¥—ã–π —Ç–µ–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–∫—Ä—ã—Ç",
            "‚Ä¢ –ù–ï –≤–∫–ª–∞–¥—ã–≤–∞–π —Ç–µ–≥–∏ –¥—Ä—É–≥ –≤ –¥—Ä—É–≥–∞",
            "‚Ä¢ –í–°–ï –≠–ú–û–î–ó–ò –¢–û–õ–¨–ö–û –í–ù–£–¢–†–ò –¢–ï–ì–û–í!",
            "",
            f"üî§ –ß–ò–°–¢–´–ô –¢–ï–ö–°–¢ –î–õ–Ø –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø:",
            f"{text}",
            "",
            "üö® –≠–¢–ê–ü 2 = –¢–û–õ–¨–ö–û –î–û–ë–ê–í–õ–ï–ù–ò–ï HTML –¢–ï–ì–û–í –ö –ì–û–¢–û–í–û–ú–£ –¢–ï–ö–°–¢–£!",
            "‚ö†Ô∏è –ù–ï –º–µ–Ω—è–π —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ - —Ç–æ–ª—å–∫–æ –æ–±–æ—Ä–∞—á–∏–≤–∞–π –≤ —Ç–µ–≥–∏!",
            "",
            "üîç –ü–ï–†–ï–î –û–¢–ü–†–ê–í–ö–û–ô –û–¢–í–ï–¢–ê:",
            "1. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –∫–∞–∂–¥—ã–π <b> –∏–º–µ–µ—Ç </b>",
            "2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –∫–∞–∂–¥—ã–π <i> –∏–º–µ–µ—Ç </i>",
            "3. –£–±–µ–¥–∏—Å—å —á—Ç–æ –ù–ï–¢ nested —Ç–µ–≥–æ–≤: <b><i>—Ç–µ–∫—Å—Ç</i></b>",
            "4. üö® –ì–õ–ê–í–ù–û–ï: –í–°–ï –≠–ú–û–î–ó–ò –í–ù–£–¢–†–ò –¢–ï–ì–û–í, –ù–ò –û–î–ù–û–ì–û –ú–ï–ñ–î–£ –¢–ï–ì–ê–ú–ò!",
            "5. –£–±–µ–¥–∏—Å—å —á—Ç–æ –ù–ï–¢ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –æ—Ç–∫—Ä—ã–≤–∞—é—â–∏—Ö —Ç–µ–≥–æ–≤!",
            "6. –ù–∞–π–¥–∏ –ö–ê–ñ–î–û–ï —ç–º–æ–¥–∑–∏ –∏ —É–±–µ–¥–∏—Å—å —á—Ç–æ –æ–Ω–æ –≤–Ω—É—Ç—Ä–∏ <b> –∏–ª–∏ <i>!",
            "",
            "üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:",
            "‚Ä¢ –ù–ò–ö–ê–ö–ò–• ```html –∏–ª–∏ –¥—Ä—É–≥–∏—Ö markdown –±–ª–æ–∫–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ!",
            "‚Ä¢ –ù–ò–ö–ê–ö–ò–• –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ –ø—Ä–µ–∞–º–±—É–ª!",
            "‚Ä¢ –¢–û–õ–¨–ö–û –≥–æ—Ç–æ–≤—ã–π HTML —Ç–µ–∫—Å—Ç –¥–ª—è Telegram!",
            "",
            "–û–¢–í–ï–¢–¨ –¢–û–õ–¨–ö–û –û–¢–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ù–´–ú HTML –¢–ï–ö–°–¢–û–ú –ë–ï–ó –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í!"
        ]
        
        return "\n".join(prompt_parts)
    
    def _parse_uniqualization_response(self, response_text: str) -> Dict[str, Any]:
        """–ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏–∏"""
        try:
            # –û—á–∏—â–∞–µ–º –æ—Ç HTML —Ç–µ–≥–æ–≤ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π (–µ—Å–ª–∏ –ò–ò –Ω–µ –ø–æ—Å–ª—É—à–∞–ª—Å—è)
            clean_text = self._strip_html_tags(response_text.strip())
            
            return {
                "success": True,
                "uniqualized_text": clean_text,
                "raw_response": response_text
            }
        except Exception as e:
            logger.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏–∏: {}", str(e))
            return {
                "success": False,
                "uniqualized_text": response_text or "–û—à–∏–±–∫–∞ —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏–∏",
                "error": str(e)
            }
    
    def _strip_html_tags(self, text: str) -> str:
        """–£–±—Ä–∞—Ç—å HTML —Ç–µ–≥–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ (–¥–ª—è —ç—Ç–∞–ø–∞ 1)"""
        try:
            import re
            # –£–±–∏—Ä–∞–µ–º –≤—Å–µ HTML —Ç–µ–≥–∏
            clean_text = re.sub(r'<[^>]+>', '', text)
            # –£–±–∏—Ä–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
            clean_text = re.sub(r'\s+', ' ', clean_text).strip()
            
            logger.debug("–û—á–∏—Å—Ç–∫–∞ HTML —Ç–µ–≥–æ–≤: {} -> {} —Å–∏–º–≤–æ–ª–æ–≤", len(text), len(clean_text))
            return clean_text
            
        except Exception as e:
            logger.error("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ HTML —Ç–µ–≥–æ–≤: {}", str(e))
            return text
    
    def _clean_markdown_code_blocks(self, text: str) -> str:
        """–£–±—Ä–∞—Ç—å markdown –∫–æ–¥ –±–ª–æ–∫–∏ (```html, ```markdown –∏ —Ç.–¥.)"""
        try:
            import re
            
            # –£–±–∏—Ä–∞–µ–º markdown –±–ª–æ–∫–∏ –≤ –Ω–∞—á–∞–ª–µ
            text = re.sub(r'^```\w*\s*\n?', '', text, flags=re.MULTILINE)
            
            # –£–±–∏—Ä–∞–µ–º markdown –±–ª–æ–∫–∏ –≤ –∫–æ–Ω—Ü–µ  
            text = re.sub(r'\n?```\s*$', '', text, flags=re.MULTILINE)
            
            # –£–±–∏—Ä–∞–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ ``` –±–µ–∑ —è–∑—ã–∫–∞
            text = re.sub(r'^```\s*\n?', '', text, flags=re.MULTILINE)
            text = re.sub(r'\n?```\s*$', '', text, flags=re.MULTILINE)
            
            return text.strip()
            
        except Exception as e:
            logger.error("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ markdown –±–ª–æ–∫–æ–≤: {}", str(e))
            return text
    
    def _clean_html_for_telegram(self, text: str) -> str:
        """–û—á–∏—Å—Ç–∫–∞ HTML —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è Telegram API"""
        try:
            import re
            
            # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã–≤–∞—é—â–∏—Ö –∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö —Ç–µ–≥–æ–≤
            text = re.sub(r'<b>\s+', '<b>', text)
            text = re.sub(r'\s+</b>', '</b>', text)
            text = re.sub(r'<i>\s+', '<i>', text)
            text = re.sub(r'\s+</i>', '</i>', text)
            
            # –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ HTML —Ç–µ–≥–∏
            text = re.sub(r'<b>\s*</b>', '', text)
            text = re.sub(r'<i>\s*</i>', '', text)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ø–∞—Ä–Ω–æ—Å—Ç—å —Ç–µ–≥–æ–≤
            text = self._ensure_html_tags_balanced(text)
            
            # –£–±–∏—Ä–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
            text = re.sub(r' +', ' ', text)  # –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã -> –æ–¥–∏–Ω –ø—Ä–æ–±–µ–ª
            text = re.sub(r'\n\n\n+', '\n\n', text)  # –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã -> –¥–≤–∞
            
            return text.strip()
            
        except Exception as e:
            logger.error("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ HTML –¥–ª—è Telegram: {}", str(e))
            return text
    
    def _ensure_html_tags_balanced(self, text: str) -> str:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å HTML —Ç–µ–≥–æ–≤"""
        try:
            import re
            
            # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Ç–µ–≥–æ–≤
            tag_pairs = [
                ('b', r'<b>', r'</b>'),
                ('i', r'<i>', r'</i>')
            ]
            
            for tag_name, open_pattern, close_pattern in tag_pairs:
                open_count = len(re.findall(open_pattern, text))
                close_count = len(re.findall(close_pattern, text))
                
                if open_count > close_count:
                    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Ç–µ–≥–∏
                    missing = open_count - close_count
                    text += f'</{tag_name}>' * missing
                    logger.debug("–î–æ–±–∞–≤–ª–µ–Ω–æ {} –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö —Ç–µ–≥–æ–≤ </{}>", missing, tag_name)
                    
                elif close_count > open_count:
                    # –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Ç–µ–≥–∏
                    extra = close_count - open_count
                    for _ in range(extra):
                        text = re.sub(close_pattern, '', text, count=1)
                    logger.debug("–£–¥–∞–ª–µ–Ω–æ {} –ª–∏—à–Ω–∏—Ö –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö —Ç–µ–≥–æ–≤ </{}>", extra, tag_name)
            
            return text
            
        except Exception as e:
            logger.error("–û—à–∏–±–∫–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ HTML —Ç–µ–≥–æ–≤: {}", str(e))
            return text
    
    def _validate_and_fix_html(self, html_text: str) -> str:
        """–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ HTML —Ä–∞–∑–º–µ—Ç–∫–∏ –¥–ª—è Telegram"""
        try:
            if not html_text or not html_text.strip():
                return html_text
            
            logger.debug("–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ HTML —Ä–∞–∑–º–µ—Ç–∫–∏: {} —Å–∏–º–≤–æ–ª–æ–≤", len(html_text))
            
            # 1. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ HTML –æ—à–∏–±–∫–∏
            import re
            
            # –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —Ç–µ–≥–∏
            html_text = re.sub(r'<strong>\s*</strong>', '', html_text)
            html_text = re.sub(r'<i>\s*</i>', '', html_text)
            
            # 2. –£–±–∏—Ä–∞–µ–º –≤–∏—Å—è—â–∏–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Ç–µ–≥–∏ –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫
            lines = html_text.split('\n')
            fixed_lines = []
            
            for line in lines:
                # –£–±–∏—Ä–∞–µ–º –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Ç–µ–≥–∏ —Å –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫ (—Å–∞–º–∞—è —á–∞—Å—Ç–∞—è –ø—Ä–æ–±–ª–µ–º–∞)
                line = re.sub(r'^\s*</strong>\s*', '', line)
                line = re.sub(r'^\s*</i>\s*', '', line)
                fixed_lines.append(line)
            
            result_text = '\n'.join(fixed_lines)
            
            # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–Ω–æ—Å—Ç—å —Ç–µ–≥–æ–≤ –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º
            result_text = self._fix_html_tag_pairs(result_text)
            
            logger.debug("HTML —Ä–∞–∑–º–µ—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞: {} -> {} —Å–∏–º–≤–æ–ª–æ–≤", 
                        len(html_text), len(result_text))
            
            return result_text
            
        except Exception as e:
            logger.error("–û—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è HTML: {}", str(e))
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
            return html_text
    
    def _fix_html_tag_pairs(self, text: str) -> str:
        """–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ä–Ω–æ—Å—Ç—å HTML —Ç–µ–≥–æ–≤"""
        try:
            import re
            
            # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Ç–∫—Ä—ã–≤–∞—é—â–∏–µ –∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Ç–µ–≥–∏
            tags_to_check = ['strong', 'i']
            
            for tag in tags_to_check:
                # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã–≤–∞—é—â–∏—Ö –∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö —Ç–µ–≥–æ–≤
                opening_count = len(re.findall(f'<{tag}>', text))
                closing_count = len(re.findall(f'</{tag}>', text))
                
                # –ï—Å–ª–∏ –Ω–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω—ã, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º
                if opening_count > closing_count:
                    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Ç–µ–≥–∏ –≤ –∫–æ–Ω–µ—Ü
                    missing_closes = opening_count - closing_count
                    text += f'</{tag}>' * missing_closes
                elif closing_count > opening_count:
                    # –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Ç–µ–≥–∏
                    extra_closes = closing_count - opening_count
                    for _ in range(extra_closes):
                        text = re.sub(f'</{tag}>', '', text, count=1)
            
            return text
            
        except Exception as e:
            logger.error("–û—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–Ω–æ—Å—Ç–∏ —Ç–µ–≥–æ–≤: {}", str(e))
            return text
    
    def _validate_and_fix_telegram_markup(self, text: str) -> str:
        """–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telegram —Ä–∞–∑–º–µ—Ç–∫–∏ –æ—Ç AI - —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏"""
        try:
            if not text or not text.strip():
                return text
            
            logger.debug("–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telegram —Ä–∞–∑–º–µ—Ç–∫–∏: {} —Å–∏–º–≤–æ–ª–æ–≤", len(text))
            
            # 1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º HTML —Ç–µ–≥–∏ –≤ Telegram —Ä–∞–∑–º–µ—Ç–∫—É (–µ—Å–ª–∏ AI –≤—Å—ë-—Ç–∞–∫–∏ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª)
            text = text.replace('<strong>', '**')
            text = text.replace('</strong>', '**')
            text = text.replace('<b>', '**')
            text = text.replace('</b>', '**')
            text = text.replace('<i>', '*')
            text = text.replace('</i>', '*')
            text = text.replace('<u>', '__')
            text = text.replace('</u>', '__')
            
            # 2. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –±–∏—Ç—É—é —Ä–∞–∑–º–µ—Ç–∫—É
            import re
            
            # –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —Ç–µ–≥–∏ —Ä–∞–∑–º–µ—Ç–∫–∏
            text = re.sub(r'\*\*\s*\*\*', '', text)  # **  **
            text = re.sub(r'\*\s*\*(?!\*)', '', text)  # * * (–Ω–æ –Ω–µ ***)
            text = re.sub(r'_{4,}', '__', text)  # ____ -> __
            text = re.sub(r'\|{4,}', '||', text)  # |||||| -> ||
            
            # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
            text = re.sub(r'\*{3,}', '**', text)  # *** -> **
            text = re.sub(r'>{2,}\s*', '>', text)  # >> -> >
            
            # 3. –£–±–∏—Ä–∞–µ–º –≤–∏—Å—è—â–∏–µ —Å–∏–º–≤–æ–ª—ã —Ä–∞–∑–º–µ—Ç–∫–∏ –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫
            lines = text.split('\n')
            fixed_lines = []
            
            for line in lines:
                # –£–±–∏—Ä–∞–µ–º –≤–∏—Å—è—â–∏–µ —Å–∏–º–≤–æ–ª—ã —Ä–∞–∑–º–µ—Ç–∫–∏ —Å –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫
                line = re.sub(r'^\s*\*\*\s*', '', line)  # ** –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏
                line = re.sub(r'^\s*\*\s*(?!\*)', '', line)  # * –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏ (–Ω–µ **)
                line = re.sub(r'^\s*__\s*', '', line)  # __ –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏  
                line = re.sub(r'^\s*\|\|\s*', '', line)  # || –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏
                fixed_lines.append(line)
            
            result_text = '\n'.join(fixed_lines)
            
            logger.debug("Telegram —Ä–∞–∑–º–µ—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞: {} -> {} —Å–∏–º–≤–æ–ª–æ–≤", 
                        len(text), len(result_text))
            
            return result_text
            
        except Exception as e:
            logger.error("–û—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Telegram —Ä–∞–∑–º–µ—Ç–∫–∏: {}", str(e))
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
            return text
    
    def _parse_analysis_response(self, response_text: str) -> Dict[str, Any]:
        """–ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenAI"""
        try:
            lines = response_text.strip().split('\n')
            
            result = {
                "relevance_score": None,
                "sentiment": None,
                "processed_text": "",
                "raw_response": response_text
            }
            
            processed_text_lines = []
            collecting_processed_text = False
            
            for line in lines:
                line = line.strip()
                
                # –ü–∞—Ä—Å–∏–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å
                if line.startswith("–†–ï–õ–ï–í–ê–ù–¢–ù–û–°–¢–¨:"):
                    try:
                        score_text = line.split(":")[1].strip()
                        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–∏—Ñ—Ä—É
                        score = int(''.join(filter(str.isdigit, score_text)))
                        if 1 <= score <= 10:
                            result["relevance_score"] = score
                    except:
                        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∏–∑: {}", line)
                
                # –ü–∞—Ä—Å–∏–º —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
                elif line.startswith("–¢–û–ù–ê–õ–¨–ù–û–°–¢–¨:"):
                    sentiment_text = line.split(":")[1].strip().lower()
                    if "–ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è" in sentiment_text or "–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è" in sentiment_text:
                        result["sentiment"] = "–ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è"
                    elif "–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è" in sentiment_text or "–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è" in sentiment_text:
                        result["sentiment"] = "–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è"
                    elif "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è" in sentiment_text:
                        result["sentiment"] = "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è"
                
                # –ù–∞—á–∏–Ω–∞–µ–º —Å–æ–±–∏—Ä–∞—Ç—å —É–Ω–∏–∫–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Å—Ç
                elif line.startswith("–£–ù–ò–ö–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –ü–û–°–¢:"):
                    collecting_processed_text = True
                elif collecting_processed_text and line:
                    processed_text_lines.append(line)
            
            # –°–æ–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ–¥–µ–ª–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            if processed_text_lines:
                raw_processed_text = "\n".join(processed_text_lines).strip()
                # –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telegram —Ä–∞–∑–º–µ—Ç–∫–∏
                result["processed_text"] = self._validate_and_fix_telegram_markup(raw_processed_text)
                
                # –õ–æ–≥–∏—Ä—É–µ–º –µ—Å–ª–∏ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                if result["processed_text"] != raw_processed_text:
                    logger.info("Telegram —Ä–∞–∑–º–µ—Ç–∫–∞ –±—ã–ª–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–º: {} -> {} —Å–∏–º–≤–æ–ª–æ–≤", 
                               len(raw_processed_text), len(result["processed_text"]))
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            if result["relevance_score"] is None:
                logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º 1")
                result["relevance_score"] = 1
            
            if not result["sentiment"]:
                logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è'")
                result["sentiment"] = "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è"
            
            if not result["processed_text"]:
                logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –ø–µ—Ä–µ–¥–µ–ª–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª")
                result["processed_text"] = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç"
            
            return result
            
        except Exception as e:
            logger.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ OpenAI: {}", str(e))
            return {
                "relevance_score": 1,
                "sentiment": "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è", 
                "processed_text": "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞",
                "raw_response": response_text,
                "error": str(e)
            }


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∏–µ–Ω—Ç–∞
_openai_client: Optional[OpenAIClient] = None


def get_openai_client() -> OpenAIClient:
    """–ü–æ–ª—É—á–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä OpenAI –∫–ª–∏–µ–Ω—Ç–∞"""
    global _openai_client
    
    if _openai_client is None:
        _openai_client = OpenAIClient()
    
    return _openai_client